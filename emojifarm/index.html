<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="theme-color" content="#ffffff" />
    <title>Cozy Emoji Farm</title>
    <link rel="shortcut icon" type="image/png" href="icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="icon.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="icon.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="icon.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="icon.png" />
    <link rel="shortcut icon" type="image/png" href="icon.png" />
    <style>
        :root {
            --soil-color: #8B4513;
            --soil-hover: #A0522D;
            --progress-bg: #ddd;
            --progress-fill: #4CAF50;
            --button-bg: #6B8E23;
            --button-hover: #7BA05B;
        }

        @font-face {
            font-family: "Delius";
            font-style: "normal";
            src: url("Delius.ttf") format("truetype");
        }

        @font-face {
            font-family: "notoemoji";
            font-style: "normal";
            src: url("NotoColorEmoji.ttf") format("truetype");
        }

        @font-face {
            font-family: "twemoji";
            font-style: "normal";
            src: url("twemoji.ttf") format("truetype");
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            user-select: none;
            background-color: #f0f8ff;
            color: #333;
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 14px;
            font-family: "Delius", Arial, Helvetica, sans-serif;
        }

        .notoemoji {
            font-family: 'Delius', 'notoemoji', sans-serif;
        }

        .twemoji {
            font-family: 'Delius', 'twemoji', sans-serif;
        }

        .title {
            color: #2E8B57;
            margin-bottom: 20px;
            text-align: center;
        }

        .game-container {
            width: 100%;
            max-width: 800px;
            background-color: #e6f7e6;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .farm-grid {
            display: grid;
            grid-template-rows: repeat(2, auto);
            grid-auto-flow: column;
            gap: 15px;
            padding-top: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
            /* Scroll horizontal */
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: #4CAF50 #ddd;
            width: 100%;
        }

        .farm-grid::-webkit-scrollbar {
            height: 8px;
        }

        .farm-grid::-webkit-scrollbar-track {
            background: #ddd;
            border-radius: 5px;
        }

        .farm-grid::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 5px;
        }

        @media (max-width: 600px) {
            .farm-grid {
                gap: 10px;
            }
        }

        .plot {
            background-color: var(--soil-color);
            border-radius: 10px;
            height: 100px;
            width: 75px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            justify-self: center;
            overflow: hidden;
            box-shadow: 0px 1px 2px #7a5f4b;
            -webkit-tap-highlight-color: transparent;
        }

        .plot:hover {
            background-color: var(--soil-hover);
            transform: translateY(-3px);
        }

        .plant {
            font-size: 2rem;
            margin-bottom: 5px;
            transition: all 0.5s ease;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .progress-container {
            width: 80%;
            height: 8px;
            background-color: var(--progress-bg);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-icon {
            position: absolute;
            margin-top: -10px;
            font-size: 10px;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--progress-fill);
            width: 0%;
            transition: width 0.5s ease;
        }

        button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-family: 'Delius';
        }

        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }

        .inventory {
            margin-top: 20px;
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .inventory-items {
            display: grid;
            grid-template-rows: repeat(2, auto);
            /* Maksimal 2 baris */
            grid-auto-flow: column;
            /* Item mengalir ke samping */
            grid-gap: 10px;
            overflow-x: auto;
            /* Scroll horizontal */
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: #4CAF50 #ddd;
            -webkit-tap-highlight-color: transparent;
        }

        .inventory-items::-webkit-scrollbar {
            height: 8px;
        }

        .inventory-items::-webkit-scrollbar-track {
            background: #ddd;
            border-radius: 5px;
        }

        .inventory-items::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 5px;
        }

        .inventory-item {
            font-size: 1.5rem;
            background-color: #f9f9f9;
            padding: 5px 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-width: 80px;
            /* Lebar minimum untuk setiap item */
            text-align: center;
        }

        .inventory-count {
            font-size: 0.9rem;
            color: #555;
        }

        .money-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2E8B57;
            margin-bottom: 15px;
            align-items: center;
        }

        .notification {
            position: fixed;
            text-align: center;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(46, 139, 87, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .show-notification {
            opacity: 1;
        }


        .wave-animation {
            animation: wavePlant 3s ease infinite;
        }

        @keyframes wavePlant {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-7px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .grow-animation {
            animation: plantGrow 1s ease infinite;
        }

        @keyframes plantGrow {
            0% {
                transform: scale(0.8);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .time-display {
            margin-bottom: 15px;
            font-size: 1rem;
            color: #555;
            display: none;
            align-items: center;
            gap: 5px;
        }

        .time-progress {
            flex-grow: 1;
            height: 10px;
            background-color: #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        .time-progress-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.5s linear;
        }

        .last-played {
            display: none;
            font-size: 0.8rem;
            color: #777;
            margin-top: 10px;
            text-align: center;
        }

        .market {
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .market-items {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-top: 5px;
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: #4CAF50 #ddd;
        }

        .market-items::-webkit-scrollbar {
            height: 8px;
        }

        .market-items::-webkit-scrollbar-track {
            background: #ddd;
            border-radius: 5px;
        }

        .market-items::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 5px;
        }

        .market-item {
            flex: 0 0 auto;
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            width: 100px;
            -webkit-tap-highlight-color: transparent;
        }

        .market-item:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
        }

        .market-item.selected {
            border: 2px solid #4CAF50;
            background-color: #e6f7e6;
        }

        .market-item-emoji {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .market-item-name {
            font-size: 0.9rem;
            color: #333;
        }

        .market-item-cost {
            font-size: 0.8rem;
            color: #555;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .popup {
            background-color: #e6f7e6;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            transform: scale(0.8);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .popup-overlay.show {
            display: flex;
        }

        .popup-overlay.show .popup {
            transform: scale(1);
            opacity: 1;
        }

        .popup-message {
            font-size: 1rem;
            color: #333;
            margin-bottom: 20px;
        }

        .popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .popup-button {
            background-color: #ffffff;
            color: #000000;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .popup-button:hover {
            background-color: #ffffff;
            transform: translateY(-2px);
        }

        .popup-cancel {
            background-color: #ffffff;
        }

        .popup-cancel:hover {
            background-color: #ffffff;
            transform: translateY(-2px);
        }

        .quest {
            margin-top: 20px;
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #2E8B57;
        }

        .quest-content {
            align-items: center;
        }

        .quest-item {
            display: flex;
            position: relative;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
            padding: 5px;
            padding-bottom: 10px;
            background-color: #f9f9f9;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .quest-npc {
            font-size: 1.5rem;
        }

        .quest-details {
            font-size: 1rem;
            color: #333;
            padding-top: 5px;
        }

        .quest-button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            position: absolute;
            right: 8px;
        }

        .quest-button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }

        .quest-button:disabled {
            background-color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .points-progress-container {
            position: relative;
            top: 4px;
            width: 70px;
            /* Lebar progress bar */
            height: 20px;
            /* Tinggi progress bar */
            background-color: var(--progress-bg);
            /* Abu-abu */
            border-radius: 7px;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
        }

        .points-progress-bar {
            height: 100%;
            background-color: var(--progress-fill);
            /* Hijau */
            width: 0%;
            transition: width 0.5s ease;
        }

        .points-text {
            position: absolute;
            top: 2px;
            left: 10px;
            font-size: 0.8rem;
            color: #333;
            text-align: center;
            z-index: 1;
        }
    </style>
</head>

<body class="twemoji">
    <div class=" game-container">
        <div class="time-display">
            <span>üïí</span>
            <div class="time-progress">
                <div class="time-progress-bar" id="time-progress"></div>
            </div>
        </div>

        <div class="money-display">
            <div style="display: block;">
                ‚≠ê <span id="level">1</span>
                <div class="points-progress-container">
                    <div class="points-progress-bar" id="points-progress"></div>
                    <span class="points-text" id="points-text">0/5</span>
                </div>
                <span style="float:right;">ü™ô <span id="money" style="padding-top: 5px;">50</span></span>
            </div>

        </div>

        <div class="farm-grid" id="farm-grid">
            <!-- Farm plots will be added here by JavaScript -->
        </div>

        <div class="market">
            <div class="panel-title">
                üå± Seed
                <span id="cancelmarket" style="display:none;float:right;">‚ùå</span>
            </div>
            <div class="market-items" id="market-items">
                <!-- Market items will be added here by JavaScript -->
            </div>
        </div>

        <div class="quest">
            <div class="panel-title">üìú Quest</div>
            <div class="quest-content" id="quest-content">
                <!-- Quest details will be added here by JavaScript -->
            </div>
        </div>

        <div class="inventory">
            <div class="panel-title">üì¶ Inventory</div>
            <div class="inventory-items" id="inventory">
                <!-- Inventory items will be added here by JavaScript -->
            </div>
        </div>

        <div class="last-played" id="last-played"></div>
    </div>

    <div class="notification" id="notification"></div>

    <div class="popup-overlay" id="popup-overlay">
        <div class="popup">
            <div class="panel-title">Confirm</div>
            <div class="popup-message" id="popup-message"></div>
            <div class="popup-buttons">
                <button class="popup-button" id="popup-confirm">‚úîÔ∏è</button>
                <button class="popup-button popup-cancel" id="popup-cancel">‚ùå</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            money: 100,
            time: 0,
            dayDuration: 60, // seconds per in-game day
            realTimeScale: 60, // 1 real second = 60 game seconds (1:60 ratio)
            lastPlayed: null,
            level: 1,
            points: 0,
            quests: [],
            plotCount: 4,
            plots: [],
            inventory: {},
            selectedSeed: null,
            plantTypes: [
                { emoji: 'üåæ', name: 'Wheat', growthTime: 6, value: 10, cost: 5 },
                { emoji: 'üåΩ', name: 'Corn', growthTime: 8, value: 15, cost: 8 },
                { emoji: 'ü•ï', name: 'Carrot', growthTime: 11, value: 15, cost: 10 },
                { emoji: 'ü•ú', name: 'Peanuts', growthTime: 11, value: 20, cost: 11 },
                { emoji: 'ü´ò', name: 'Beans', growthTime: 13, value: 16, cost: 12 },
                { emoji: 'ü•í', name: 'Cucumber', growthTime: 13, value: 16, cost: 14 },
                { emoji: 'üå∂Ô∏è', name: 'Pepper', growthTime: 17, value: 20, cost: 15 },
                { emoji: 'ü´ë', name: 'Bell Pepper', growthTime: 18, value: 25, cost: 16 },
                { emoji: 'ü•î', name: 'Potato', growthTime: 25, value: 30, cost: 20 },
                { emoji: 'üçÜ', name: 'Eggplant', growthTime: 20, value: 20, cost: 15 },
                { emoji: 'üçé', name: 'Apple', growthTime: 25, value: 25, cost: 17 },
                { emoji: 'üçì', name: 'Strawberry', growthTime: 27, value: 25, cost: 18 },
                { emoji: 'üçê', name: 'Pear', growthTime: 28, value: 25, cost: 17 },
                { emoji: 'üçä', name: 'Orange', growthTime: 30, value: 25, cost: 16 },
                { emoji: 'üçã', name: 'Lemon', growthTime: 30, value: 25, cost: 16 },
                { emoji: 'üçã‚Äçüü©', name: 'Lime', growthTime: 30, value: 25, cost: 17 },
                { emoji: 'üçå', name: 'Banana', growthTime: 25, value: 25, cost: 18 },
                { emoji: 'üçâ', name: 'Watermelon', growthTime: 27, value: 30, cost: 20 },
                { emoji: 'üçá', name: 'Grapes', growthTime: 35, value: 35, cost: 30 },
                { emoji: 'ü´ê', name: 'Blueberries', growthTime: 33, value: 30, cost: 25 },
                { emoji: 'üçà', name: 'Melon', growthTime: 45, value: 45, cost: 40 },
                { emoji: 'üçí', name: 'Cherry', growthTime: 30, value: 30, cost: 25 },
                { emoji: 'üçë', name: 'Peach', growthTime: 40, value: 40, cost: 35 },
                { emoji: 'ü•≠', name: 'Mango', growthTime: 35, value: 25, cost: 20 },
                { emoji: 'üçç', name: 'Pineapple', growthTime: 35, value: 25, cost: 20 },
                { emoji: 'ü••', name: 'Coconut', growthTime: 38, value: 20, cost: 15 },
                { emoji: 'ü•ù', name: 'Kiwi', growthTime: 40, value: 28, cost: 22 },
                { emoji: 'üçÖ', name: 'Tomato', growthTime: 30, value: 25, cost: 20 },
                { emoji: 'ü•ë', name: 'Avocado', growthTime: 30, value: 35, cost: 25 },
                { emoji: 'ü´õ', name: 'Peas', growthTime: 20, value: 20, cost: 15 },
                { emoji: 'ü•¶', name: 'Broccoli', growthTime: 30, value: 25, cost: 15 },
                { emoji: 'ü•¨', name: 'Lettuce', growthTime: 20, value: 20, cost: 13 },
                { emoji: 'üçÑ', name: 'Mushroom', growthTime: 20, value: 15, cost: 10 },
                { emoji: 'üåπ', name: 'Rose', growthTime: 20, value: 30, cost: 20 },
                { emoji: 'üå∑', name: 'Tulip', growthTime: 20, value: 15, cost: 10 },
                { emoji: 'ü™ª', name: 'Hyacinth', growthTime: 25, value: 25, cost: 20 },
                { emoji: 'ü™∑', name: 'Lotus', growthTime: 30, value: 45, cost: 35 },
                { emoji: 'üå∫', name: 'Hibiscus', growthTime: 30, value: 35, cost: 30 },
                { emoji: 'üåº', name: 'Daisy', growthTime: 30, value: 40, cost: 30 },
                { emoji: 'üåª', name: 'Sunflower', growthTime: 35, value: 50, cost: 35 },
                { emoji: 'üå∏', name: 'Sakura', growthTime: 35, value: 50, cost: 35 },
                { emoji: 'üü´', name: 'Land', growthTime: 0, value: 0, cost: 300 }
            ],
            gameInterval: null,
            npcs: [
                'üßîüèª‚Äç‚ôÇÔ∏è', 'üßîüèª', 'ü§°', 'üëª', 'ü§ñ', 'üëΩ', 'üßúüèª‚Äç‚ôÇÔ∏è', 'üßöüèª‚Äç‚ôÇÔ∏è',
                'üßû‚Äç‚ôÇÔ∏è', 'üßùüèª‚Äç‚ôÇÔ∏è', 'üßôüèª‚Äç‚ôÇÔ∏è', 'üßõüèª‚Äç‚ôÇÔ∏è', 'üßü‚Äç‚ôÇÔ∏è', 'ü•∑üèª', 'üéÖüèª',
                'üíÇüèª‚Äç‚ôÇÔ∏è', 'ü§¥üèª', 'üë∑üèª‚Äç‚ôÇÔ∏è', 'üëÆüèª‚Äç‚ôÇÔ∏è', 'üïµüèª‚Äç‚ôÇÔ∏è', 'üë®üèª‚Äç‚úàÔ∏è', 'üë®üèª‚Äçüî¨',
                'üë®üèª‚Äç‚öïÔ∏è', 'üë®üèª‚Äçüîß', 'üë®üèª‚Äçüè≠', 'üë®üèª‚Äçüöí', 'üë®üèª‚Äçüåæ', 'üë®üèª‚Äçüíº',
                'üë®üèª‚Äç‚öñÔ∏è', 'üë®üèª‚Äçüé§', 'üë®üèª‚Äçüé®', 'üë®üèª‚Äçüç≥', 'üßïüèª', 'üë≥üèª‚Äç‚ôÇÔ∏è',
                'üë≤üèª', 'üë®üèª‚Äçü¶≥', 'üë®üèª‚Äçü¶±', 'üë®üèª‚Äçü¶≤', 'üï¥üèª', 'üíÉüèª', 'üï∫üèª'
            ]
        };

        // DOM elements
        const farmGrid = document.getElementById('farm-grid');
        const marketItems = document.getElementById('market-items');
        const moneyDisplay = document.getElementById('money');
        const inventoryDisplay = document.getElementById('inventory');
        const notification = document.getElementById('notification');
        const timeProgressBar = document.getElementById('time-progress');
        const lastPlayedDisplay = document.getElementById('last-played');
        const cancelmarket = document.getElementById('cancelmarket');
        const levelDisplay = document.getElementById('level');
        const pointsProgress = document.getElementById('points-progress');
        const pointsText = document.getElementById('points-text');
        const questContent = document.getElementById('quest-content');

        const popupOverlay = document.getElementById('popup-overlay');
        const popupMessage = document.getElementById('popup-message');
        const popupConfirm = document.getElementById('popup-confirm');
        const popupCancel = document.getElementById('popup-cancel');

        // Initialize the game
        const initGame = () => {
            loadGame();
            calculateOfflineProgress();
            createFarmPlots();
            populateMarket();
            updateUI();
            startGameLoop();
            updateLastPlayedDisplay();
            generateQuests();
        }

        // Dapatkan tanaman yang tersedia di market berdasarkan level
        const getAvailablePlants = (level) => {
            // Pada Level 1, hanya Wheat dan Corn
            const basePlants = gameState.plantTypes.slice(0, 2); // üåæ, üåΩ
            // Tambah 1 tanaman per level setelah Level 1
            const additionalPlants = level > 1 ? gameState.plantTypes.slice(2, 2 + (level - 1)) : [];
            // Selalu sertakan Land
            const landPlant = gameState.plotCount < 12 ? gameState.plantTypes.find(p => p.emoji === 'üü´') : [];
            if (landPlant.length == 0) {
                if (additionalPlants.length == 0) {
                    return [...basePlants];
                } else {
                    return [...basePlants, ...additionalPlants];
                }
            } else if (additionalPlants.length == 0) {
                if (landPlant.length == 0) {
                    return [...basePlants];
                } else {
                    return [...basePlants, landPlant];
                }
            } else {
                return [...basePlants, ...additionalPlants, landPlant];
            }
        }

        // Populate market items
        const populateMarket = () => {
            marketItems.innerHTML = '';

            const availablePlants = getAvailablePlants(gameState.level);

            availablePlants.forEach(plant => {
                const item = document.createElement('div');
                item.className = 'market-item';
                item.dataset.emoji = plant.emoji;
                item.innerHTML = `
                    <div class="market-item-emoji">${plant.emoji}</div>
                    <div class="market-item-name">${plant.name}</div>
                    <div class="market-item-cost">ü™ô${plant.cost}</div>
                `;
                item.addEventListener('click', async () => {
                    // Remove selected class from all items
                    document.querySelectorAll('.market-item').forEach(i => i.classList.remove('selected'));
                    cancelmarket.style.display = "block";
                    if (plant.emoji == "üü´") {
                        cancelmarket.style.display = "none";
                        let confirmed = await showPopup('<span style="font-size:20px;">Buy Land üü´?</span>');
                        if (confirmed) {
                            const seedCost = getPlantCost(plant.emoji);
                            if (gameState.money >= seedCost) {
                                gameState.money -= seedCost;
                                gameState.plotCount++;
                                updateUI();
                                createFarmPlots();
                                populateMarket();
                                showNotification(`New Land üü´ Added!`);
                            } else {
                                showNotification(`Not enough ü™ô to buy Land!`);
                            }
                        }
                    } else {
                        // Add selected class to clicked item
                        item.classList.add('selected');
                        gameState.selectedSeed = plant.emoji;
                        // showNotification(`Selected ${plant.name} for planting!`);
                    }
                });
                marketItems.appendChild(item);
            });
        }

        // Calculate growth while game was closed
        const calculateOfflineProgress = () => {
            if (!gameState.lastPlayed) return;
            const now = new Date();
            const lastPlayed = new Date(gameState.lastPlayed);
            const secondsPassed = (now - lastPlayed) / 1000;
            const gameSecondsPassed = secondsPassed * gameState.realTimeScale;
            if (gameSecondsPassed > 0) {
                const maxDays = 30; // Batas maksimum 30 hari offline
                const daysPassed = Math.min(Math.floor(gameSecondsPassed / gameState.dayDuration), maxDays);
                const remainingSeconds = gameSecondsPassed % gameState.dayDuration;
                if (daysPassed > 0) {
                    for (let i = 0; i < daysPassed; i++) {
                        advanceDay();
                    }
                    showNotification(`Welcome back!`);
                }
                gameState.time = remainingSeconds;
            }
        }

        // Create farm plots
        const createFarmPlots = () => {
            farmGrid.innerHTML = '';

            // Adjust plot count based on screen size
            const screenWidth = window.innerWidth;

            // Initialize plots array if needed
            while (gameState.plots.length < gameState.plotCount) {
                gameState.plots.push({ plant: null, growth: 0, plantedAt: null });
            }

            // Trim if we have more plots than needed
            gameState.plots = gameState.plots.slice(0, gameState.plotCount);

            for (let i = 0; i < gameState.plotCount; i++) {
                const plot = document.createElement('div');
                plot.className = 'plot';
                plot.dataset.index = i;

                const plant = document.createElement('div');
                plant.className = 'plant grow-animation';
                plant.textContent = gameState.plots[i].plant || '';

                const progressContainer = document.createElement('div');
                progressContainer.className = 'progress-container';

                const progressIcon = document.createElement('div');
                progressIcon.textContent = gameState.plots[i].plant || '';
                progressIcon.className = 'progress-icon';

                const progressBar = document.createElement('div');
                progressBar.className = 'progress-bar';

                // Calculate growth progress
                if (gameState.plots[i].plant) {
                    const growthTime = getGrowthTime(gameState.plots[i].plant);
                    const growthProgress = Math.min(gameState.plots[i].growth, growthTime);
                    progressBar.style.width = `${(growthProgress / growthTime) * 100}%`;
                } else {
                    progressBar.style.width = '0%';
                }

                progressContainer.appendChild(progressIcon);
                progressContainer.appendChild(progressBar);
                plot.appendChild(plant);
                plot.appendChild(progressContainer);

                plot.addEventListener('click', () => handlePlotClick(i));
                farmGrid.appendChild(plot);
            }
        }

        // Handle plot click
        const handlePlotClick = (index) => {
            const plot = gameState.plots[index];

            if (!plot.plant) {
                // Plant a seed if empty and seed is selected
                if (gameState.selectedSeed) {
                    const seedCost = getPlantCost(gameState.selectedSeed);

                    if (gameState.money >= seedCost) {
                        plot.plant = gameState.selectedSeed;
                        plot.growth = 0;
                        plot.plantedAt = new Date().toISOString();
                        gameState.money -= seedCost;
                        updatePlotUI(index);
                        updateUI();
                        // showNotification(`Planted ${getPlantName(gameState.selectedSeed)} for ü™ô${seedCost}!`);
                        gameState.selectedSeed = null;
                        // Reset selected item in market
                        document.querySelectorAll('.market-item').forEach(i => i.classList.remove('selected'));
                        cancelmarket.style.display = "none";
                        saveGame();
                    } else {
                        showNotification(`Not enough ü™ô to buy ${getPlantName(gameState.selectedSeed)}!`);
                    }
                }
            } else if (isReadyToHarvest(index)) {
                // Harvest if ready
                harvestPlant(index);
            }
        }

        // Check if plant is ready to harvest
        const isReadyToHarvest = (index) => {
            const plot = gameState.plots[index];
            return plot.growth >= getGrowthTime(plot.plant);
        }

        // Harvest a plant
        const harvestPlant = (index) => {
            const plot = gameState.plots[index];
            const plantEmoji = plot.plant;
            const plantValue = getPlantValue(plantEmoji);

            // Add to inventory
            if (!gameState.inventory[plantEmoji]) {
                gameState.inventory[plantEmoji] = 0;
            }
            gameState.inventory[plantEmoji]++;

            // Add money
            // gameState.money += plantValue;

            // Clear the plot
            plot.plant = null;
            plot.growth = 0;
            plot.plantedAt = null;

            // Update UI
            updatePlotUI(index);
            updateUI();

            // Show notification
            // showNotification(`Harvested ${getPlantName(plantEmoji)} for ü™ô${plantValue}!`);
            saveGame();
        }

        // Start the game loop for automatic day progression
        const startGameLoop = () => {
            if (gameState.gameInterval) { clearInterval(gameState.gameInterval); }
            gameState.gameInterval = setInterval(() => {
                gameState.time += 0.1;
                updateTimeDisplay();
                const hasGrowingPlants = gameState.plots.some(plot => plot.plant);
                if (hasGrowingPlants) { updatePlantGrowth(0.1); }
                if (gameState.time >= gameState.dayDuration) { nextDay(); }
            }, 100);
        }

        // Update plant growth based on elapsed time
        const updatePlantGrowth = (seconds) => {
            gameState.plots.forEach((plot, index) => {
                if (plot.plant) {
                    plot.growth += seconds;
                    if (plot.growth > getGrowthTime(plot.plant)) {
                        plot.growth = getGrowthTime(plot.plant); // Cap at max growth
                    }
                    updatePlotUI(index);
                }
            });
        }

        // Update time display
        const updateTimeDisplay = () => {
            const progressPercent = (gameState.time / gameState.dayDuration) * 100;
            timeProgressBar.style.width = `${progressPercent}%`;
        }

        // Advance to next day
        const advanceDay = () => {
            // Grow plants by a full day
            gameState.plots.forEach((plot, index) => {
                if (plot.plant) {
                    plot.growth++;
                    if (plot.growth > getGrowthTime(plot.plant)) {
                        plot.growth = getGrowthTime(plot.plant); // Cap at max growth
                    }
                    updatePlotUI(index);
                }
            });
        }

        // Complete day transition
        const nextDay = () => {
            advanceDay();
            gameState.time = 0;
            updateTimeDisplay();
            updateUI();
            // showNotification(`Day ${gameState.day} begins!`);
            saveGame();
        }

        // Update a single plot's UI
        const updatePlotUI = (index) => {
            if (farmGrid.children[index] != null) {
                const plotElement = farmGrid.children[index];
                const plot = gameState.plots[index];
                const plantElement = plotElement.querySelector('.plant');
                const progressBar = plotElement.querySelector('.progress-bar');
                const progressIcon = plotElement.querySelector('.progress-icon');

                if (plot.plant) {
                    // Show seedling if not fully grown
                    if (plot.growth < getGrowthTime(plot.plant)) {
                        plantElement.textContent = 'üå±';
                        plantElement.classList.remove('wave-animation');
                        plantElement.classList.add('grow-animation');
                        progressIcon.textContent = plot.plant;
                    } else {
                        plantElement.textContent = plot.plant;
                        plantElement.classList.add('wave-animation');
                        plantElement.classList.remove('grow-animation');
                        progressIcon.textContent = '';
                    }

                    progressBar.style.width = `${(plot.growth / getGrowthTime(plot.plant)) * 100}%`;
                } else {
                    progressIcon.textContent = '';
                    plantElement.textContent = '';
                    progressBar.style.width = '0%';
                }
            }
        }

        // Update all UI elements
        const updateUI = () => {
            moneyDisplay.textContent = gameState.money;
            levelDisplay.textContent = gameState.level;
            const pointsNeeded = getPointsNeededForNextLevel(gameState.level);
            pointsProgress.style.width = `${(gameState.points / pointsNeeded) * 100}%`;
            pointsText.textContent = `${gameState.points}/${pointsNeeded}`;

            // Update inventory display
            inventoryDisplay.innerHTML = '';
            Object.entries(gameState.inventory).forEach(([emoji, count]) => {
                if (count > 0) {
                    const item = document.createElement('div');
                    item.className = 'inventory-item';
                    item.style.cursor = 'pointer'; // Visual feedback bahwa item bisa diklik
                    item.innerHTML = `
                            <span>${emoji}</span>
                            <span class="inventory-count">${count}</span>
                        `;
                    // Tambahkan event listener untuk penjualan
                    item.addEventListener('click', () => {
                        const plantName = getPlantName(emoji);
                        const totalValue = count * (getPlantCost(emoji) + 2);
                        showPopup(`
                                Sell ${plantName} (${emoji}) for ü™ô${(getPlantCost(emoji) + 2)} each?<br>
                                <input type="number" id="sell-quantity" min="1" max="${count}" value="${count}" style="width:100px;margin:10px;padding:5px 8px;border-radius: 5px;border:2px solid #2E8B57;text-align:right;outline:none;">
                                <div>Total: ü™ô<span id="sell-total">${count * (getPlantCost(emoji) + 2)}</span></div>
                            `).then(confirmed => {
                            if (confirmed) {
                                const quantityInput = document.getElementById('sell-quantity');
                                const quantity = parseInt(quantityInput.value);
                                if (quantity > 0 && quantity <= count) {
                                    gameState.money += quantity * (getPlantCost(emoji) + 2) || 0;
                                    gameState.inventory[emoji] -= quantity;
                                    if (gameState.inventory[emoji] <= 0) {
                                        delete gameState.inventory[emoji];
                                    }
                                    updateUI();
                                    saveGame();
                                    showNotification(`Sold ${quantity} ${plantName} for ü™ô${quantity * getPlantValue(emoji)}!`);
                                }
                            }
                        });

                        document.getElementById('sell-quantity').addEventListener('input', (e) => {
                            let quantity = parseInt(e.target.value);
                            if (isNaN(quantity) || quantity < 1) quantity = 1;
                            if (quantity > count) quantity = count;
                            e.target.value = quantity;
                            document.getElementById('sell-total').textContent = quantity * (getPlantCost(emoji) + 2);
                        });
                    });
                    inventoryDisplay.appendChild(item);
                }
            });

            // Perbarui quest UI untuk memeriksa ketersediaan inventory
            updateQuestUI();
        }

        // Update last played display
        const updateLastPlayedDisplay = () => {
            if (gameState.lastPlayed) {
                const lastPlayed = new Date(gameState.lastPlayed);
                lastPlayedDisplay.textContent = `Last played: ${lastPlayed.toLocaleString()}`;
            }
        }

        // Show notification
        let notificationTimeout;
        const showNotification = (message) => {
            clearTimeout(notificationTimeout);
            notification.classList.remove('show-notification');
            notification.textContent = message;
            notification.classList.add('show-notification');
            notificationTimeout = setTimeout(() => {
                notification.classList.remove('show-notification');
            }, 3000);
        };

        // Helper functions to get plant info
        const getGrowthTime = (emoji) => {
            const plant = gameState.plantTypes.find(p => p.emoji === emoji);
            return plant ? plant.growthTime : 0;
        }

        const getPlantValue = (emoji) => {
            const plant = gameState.plantTypes.find(p => p.emoji === emoji);
            return plant ? plant.value : 0;
        }

        const getPlantCost = (emoji) => {
            const plant = gameState.plantTypes.find(p => p.emoji === emoji);
            return plant ? plant.cost : 0;
        }

        const getPlantName = (emoji) => {
            const plant = gameState.plantTypes.find(p => p.emoji === emoji);
            return plant ? plant.name : 'Unknown Plant';
        }

        // Save game to localStorage
        const saveGame = () => {
            gameState.lastPlayed = new Date().toISOString();
            localStorage.setItem('emojiFarm', JSON.stringify(gameState));
            updateLastPlayedDisplay();
        }

        // Load game from localStorage
        const loadGame = () => {
            const savedGame = localStorage.getItem('emojiFarm');
            if (savedGame) {
                try {
                    const parsed = JSON.parse(savedGame);

                    // Migrate old save format if needed
                    if (!parsed.plots) {
                        parsed.plots = Array(parsed.plotCount || 4).fill().map(() => ({ plant: null, growth: 0, plantedAt: null }));
                    }

                    // Migrate quests if not present or old format (single quest)
                    if (!parsed.quests) {
                        parsed.quests = parsed.quest ? [parsed.quest] : [];
                        delete parsed.quest;
                    }

                    // Migrate questCompletedCount if not present
                    if (!parsed.questCompletedCount) {
                        parsed.questCompletedCount = parsed.quests.reduce((sum, q) => sum + (q.completedCount || 0), 0);
                    }

                    // Migrate level and points if not present
                    if (!parsed.level) {
                        parsed.level = 1;
                    }
                    if (!parsed.points) {
                        parsed.points = 0;
                    }

                    // Ensure each plot has plantedAt property
                    parsed.plots.forEach(plot => {
                        if (!plot.plantedAt && plot.plant) {
                            plot.plantedAt = new Date().toISOString();
                        }
                    });

                    Object.assign(gameState, parsed);
                } catch (e) {
                    console.error('Failed to load save:', e);
                }
            }

            // Pastikan ada hingga 3 quest saat memuat
            generateQuests();
        }

        // Show popup with message and return a Promise
        const showPopup = (message) => {
            return new Promise((resolve) => {
                popupMessage.innerHTML = message;
                popupOverlay.classList.add('show');

                // Event listener untuk tombol Confirm
                const confirmHandler = () => {
                    popupOverlay.classList.remove('show');
                    popupConfirm.removeEventListener('click', confirmHandler);
                    popupCancel.removeEventListener('click', cancelHandler);
                    resolve(true);
                };

                // Event listener untuk tombol Cancel
                const cancelHandler = () => {
                    popupOverlay.classList.remove('show');
                    popupConfirm.removeEventListener('click', confirmHandler);
                    popupCancel.removeEventListener('click', cancelHandler);
                    resolve(false);
                };

                popupConfirm.addEventListener('click', confirmHandler);
                popupCancel.addEventListener('click', cancelHandler);
            });
        }

        cancelmarket.addEventListener('click', async () => {
            gameState.selectedSeed = null;
            document.querySelectorAll('.market-item').forEach(i => i.classList.remove('selected'));
            cancelmarket.style.display = "none";
        });

        // Generate new quest
        // Generate single quest
        const generateSingleQuest = () => {
            gameState.questCompletedCount = gameState.questCompletedCount == undefined ? 0 : gameState.questCompletedCount;
            const availablePlants = getAvailablePlants(gameState.level).filter(p => p.emoji !== 'üü´');
            const plant = availablePlants[Math.floor(Math.random() * availablePlants.length)];
            const baseQuantity = gameState.questCompletedCount > 10 ? Math.floor(Math.random() * 10) + 1 : Math.floor(Math.random() * 3) + 1;
            const quantity = baseQuantity;
            const usedNPCs = gameState.quests.map(q => q.npc);
            const availableNPCs = gameState.npcs.filter(npc => !usedNPCs.includes(npc));
            if (availableNPCs.length === 0) return null; // Cegah quest jika tidak ada NPC
            const npc = availableNPCs[Math.floor(Math.random() * availableNPCs.length)];
            return { npc, plantEmoji: plant.emoji, quantity };
        }

        // Generate quests up to 3
        const generateQuests = () => {
            while (gameState.quests.length < 3 && gameState.npcs.length > gameState.quests.length) {
                const quest = generateSingleQuest();
                if (quest) gameState.quests.push(quest);
            }
            updateQuestUI();
            saveGame();
        }

        // Complete quest by index
        const completeQuest = (index) => {
            const quest = gameState.quests[index];
            const { plantEmoji, quantity } = quest;
            const inventoryCount = gameState.inventory[plantEmoji] || 0;

            if (inventoryCount >= quantity) {
                // Kurangi inventory
                gameState.inventory[plantEmoji] -= quantity;
                if (gameState.inventory[plantEmoji] <= 0) {
                    delete gameState.inventory[plantEmoji];
                }

                // Tambah poin dan uang
                gameState.points += 2; // 2 poin per quest
                const plantValue = getPlantValue(plantEmoji);
                const reward = (plantValue * quantity);// + (gameState.level * 10);
                gameState.money += reward;

                // Tingkatkan questCompletedCount
                gameState.questCompletedCount += 1;

                // Notifikasi dan update
                showNotification(`Quest completed! Gained ü™ô${reward}!`);

                // Periksa kenaikan level
                checkLevelUp();

                // Hapus quest dan tambahkan quest baru
                gameState.quests.splice(index, 1);
                generateQuests();

                updateUI();
            } else {
                showNotification(`Not enough ${getPlantName(plantEmoji)}! Need ${quantity}, have ${inventoryCount}.`);
            }
        }

        // Update quest UI
        const updateQuestUI = () => {
            questContent.innerHTML = '';

            gameState.quests.forEach((quest, index) => {
                const { npc, plantEmoji, quantity } = quest;
                const inventoryCount = gameState.inventory[plantEmoji] || 0;
                const isCompletable = inventoryCount >= quantity;

                const questItem = document.createElement('div');
                questItem.className = 'quest-item';
                questItem.innerHTML = `
                        <div class="quest-npc">${npc}</div>
                        <div class="quest-details">
                            ${quantity} ${plantEmoji} ${getPlantName(plantEmoji)}
                        </div>
                        <button class="quest-button" ${isCompletable ? '' : 'disabled'}>Complete</button>
                    `;

                const completeButton = questItem.querySelector('.quest-button');
                completeButton.addEventListener('click', () => completeQuest(index));

                questContent.appendChild(questItem);
            });
        }

        // Hitung poin yang dibutuhkan untuk level berikutnya
        const getPointsNeededForNextLevel = (currentLevel) => {
            return 5 * currentLevel; // 5 untuk level 2, 10 untuk level 3, 15 untuk level 4, dst.
        }

        // Periksa dan naikkan level jika poin cukup
        const checkLevelUp = () => {
            let pointsNeeded = getPointsNeededForNextLevel(gameState.level);
            while (gameState.points >= pointsNeeded) {
                gameState.points -= pointsNeeded; // Kurangi poin yang digunakan
                gameState.level += 1; // Naik level
                pointsNeeded = getPointsNeededForNextLevel(gameState.level); // Hitung poin untuk level berikutnya
                showNotification(`Level up! Reached Level ${gameState.level}!`);

                const availablePlants = getAvailablePlants(gameState.level);
                const numplantnow = document.getElementsByClassName("market-item").length;
                if (availablePlants.length > numplantnow && numplantnow > 0) {
                    setTimeout(() => {
                        showNotification(`New Plant Added!`);
                    }, 2000);
                }
                populateMarket(); // Perbarui market dengan tanaman baru
            }
        }

        // Save game when page is closed
        window.addEventListener('beforeunload', () => {
            saveGame();
        });

        // Initialize the game
        initGame();
    </script>
</body>

</html>